name: iOS-ipa-build

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-ios:
    name: ğŸ‰ iOS Build
    runs-on: macos-latest
    steps:
      - name: ğŸ— Checkout code
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: âš™ï¸ Prebuild (Generate Native Code)
        run: npx expo prebuild --platform ios --no-install

      - name: ğŸ“¦ Update CocoaPods repo
        run: pod repo update
        working-directory: ios

      - name: ğŸ“¦ Install Pods
        run: pod install
        working-directory: ios

      - name: ğŸ”¨ Build iOS (No Code Sign)
        run: |
          xcodebuild -workspace ios/BudTracker.xcworkspace \
            -scheme BudTracker \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: ğŸ“ Create Payload directory
        run: mkdir Payload
        working-directory: ios/build/Build/Products/Release-iphoneos

      - name: ğŸ“¦ Move app to Payload
        run: mv BudTracker.app/ Payload
        working-directory: ios/build/Build/Products/Release-iphoneos

      - name: ğŸ¤ Zip IPA
        run: zip -qq -r -9 BudTracker.ipa Payload
        working-directory: ios/build/Build/Products/Release-iphoneos

      - name: ğŸ“¤ Upload to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ios/build/Build/Products/Release-iphoneos/BudTracker.ipa
          tag: v1.0
          overwrite: true
          make_latest: true
          body: "Unsigned iOS build for sideloading"
